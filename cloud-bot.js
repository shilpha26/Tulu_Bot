const TelegramBot = require('node-telegram-bot-api');
const fetch = require('node-fetch');
const express = require('express');
const { MongoClient } = require('mongodb');

// SECURE: Only use environment variables
const token = process.env.TELEGRAM_TOKEN;
const PORT = process.env.PORT || 3000;

// Exit if token not provided
if (!token) {
    console.error('‚ùå TELEGRAM_TOKEN environment variable not set');
    console.error('üí° Set it in Render.com dashboard under Environment Variables');
    process.exit(1);
}

// MongoDB connection with fallback
const mongoUri = process.env.MONGODB_URI;
let client;
let db;
let mongoAvailable = false;

if (!mongoUri) {
    console.log('‚ö†Ô∏è MONGODB_URI not set - running with memory storage only');
    mongoAvailable = false;
} else {
    console.log('üóÑÔ∏è MongoDB URI detected - will attempt connection');
}

const bot = new TelegramBot(token, {polling: true});

console.log('üöÄ Complete Cloud Tulu Bot Starting...\n');

// Smart Keep-Alive System
let keepAliveInterval = null;
let lastActivityTime = null;
const KEEP_ALIVE_DURATION = 30 * 60 * 1000; // 30 minutes
const PING_INTERVAL = 10 * 60 * 1000; // 10 minutes

function startKeepAlive() {
    if (keepAliveInterval) {
        clearInterval(keepAliveInterval);
    }
    
    lastActivityTime = Date.now();
    console.log('üèì Starting keep-alive session for 30 minutes');
    
    keepAliveInterval = setInterval(() => {
        const now = Date.now();
        const timeSinceActivity = now - lastActivityTime;
        
        if (timeSinceActivity > KEEP_ALIVE_DURATION) {
            clearInterval(keepAliveInterval);
            keepAliveInterval = null;
            console.log('üò¥ Keep-alive session ended - bot can sleep');
            return;
        }
        
        const baseUrl = process.env.RENDER_EXTERNAL_URL || `http://localhost:${PORT}`;
        fetch(`${baseUrl}/health`)
            .then(() => {
                const remainingTime = Math.ceil((KEEP_ALIVE_DURATION - timeSinceActivity) / (60 * 1000));
                console.log(`üèì Keep-alive ping sent - ${remainingTime} min remaining`);
            })
            .catch(err => console.log('üö® Keep-alive ping failed:', err.message));
            
    }, PING_INTERVAL);
}

function extendKeepAlive() {
    lastActivityTime = Date.now();
    
    if (!keepAliveInterval) {
        startKeepAlive();
    } else {
        console.log('üîÑ Keep-alive session extended');
    }
}

// Enhanced MongoDB initialization with robust error handling
async function initializeMongoDB() {
    if (!mongoUri) {
        console.log('‚ö†Ô∏è No MongoDB URI - skipping database connection');
        return false;
    }

    try {
        console.log('üîß Connecting to MongoDB Atlas (Mumbai)...');
        
        client = new MongoClient(mongoUri, {
            // Enhanced SSL/TLS configuration
            tls: true,
            tlsAllowInvalidCertificates: false,
            tlsAllowInvalidHostnames: false,
            
            // Connection timeouts
            serverSelectionTimeoutMS: 15000,
            socketTimeoutMS: 45000,
            connectTimeoutMS: 10000,
            
            // Pool settings
            maxPoolSize: 10,
            minPoolSize: 1,
            
            // Retry configuration
            retryWrites: true,
            retryReads: true,
            w: 'majority',
            
            // Stability options
            heartbeatFrequencyMS: 10000,
            serverSelectionRetryDelayMS: 2000,
            maxIdleTimeMS: 30000
        });
        
        console.log('üì° Attempting MongoDB connection...');
        await client.connect();
        
        console.log('üîÑ Testing database connection...');
        db = client.db('tulubot');
        
        // Test connection with multiple retries
        let pingSuccess = false;
        for (let attempt = 1; attempt <= 3; attempt++) {
            try {
                await db.admin().ping();
                pingSuccess = true;
                console.log('‚úÖ Database ping successful');
                break;
            } catch (pingError) {
                console.log(`‚ö†Ô∏è Ping attempt ${attempt}/3 failed: ${pingError.message}`);
                if (attempt < 3) {
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
            }
        }
        
        if (!pingSuccess) {
            throw new Error('Failed to ping database after 3 attempts');
        }
        
        console.log('‚úÖ Connected to MongoDB Atlas (Mumbai)');
        
        // Create index with error handling
        try {
            await db.collection('learned_words').createIndex({ english: 1 }, { unique: true });
            console.log('‚úÖ MongoDB collection indexed');
        } catch (indexError) {
            if (indexError.code === 85) {
                console.log('‚úÖ Index already exists - skipping creation');
            } else {
                console.log('‚ö†Ô∏è Index creation warning:', indexError.message);
            }
        }
        
        const wordCount = await db.collection('learned_words').countDocuments();
        console.log(`üìö MongoDB loaded with ${wordCount} learned words`);
        
        return true;
    } catch (error) {
        console.error('‚ùå MongoDB connection failed:', error.message);
        
        if (error.message.includes('SSL') || error.message.includes('TLS')) {
            console.log('üîß SSL/TLS connection issue detected');
            console.log('üí° This is common on first deployment - bot will use memory storage');
        } else if (error.message.includes('timeout')) {
            console.log('‚è∞ Connection timeout - network may be slow');
            console.log('üí° Bot will continue with base dictionary');
        }
        
        console.log('‚ö†Ô∏è Continuing without MongoDB - bot will work with memory storage');
        return false;
    }
}

// MongoDB operations with fallback
async function saveWordToMongoDB(englishWord, tuluWord) {
    if (!mongoAvailable || !db) {
        console.log(`üíæ Memory save: "${englishWord}" = "${tuluWord}" (MongoDB unavailable)`);
        return true; // Return success for memory storage
    }

    try {
        await db.collection('learned_words').replaceOne(
            { english: englishWord.toLowerCase().trim() },
            { 
                english: englishWord.toLowerCase().trim(), 
                tulu: tuluWord.trim(),
                createdAt: new Date(),
                updatedAt: new Date()
            },
            { upsert: true }
        );
        
        console.log(`üíæ MongoDB save: "${englishWord}" = "${tuluWord}"`);
        return true;
    } catch (error) {
        console.error('‚ùå MongoDB save failed:', error.message);
        console.log(`üíæ Fallback to memory: "${englishWord}" = "${tuluWord}"`);
        return true; // Still return success for memory storage
    }
}

async function loadLearnedWordsFromMongoDB() {
    if (!mongoAvailable || !db) {
        console.log('üìñ Loading from memory storage (MongoDB unavailable)');
        return {};
    }

    try {
        const words = {};
        const cursor = db.collection('learned_words').find({});
        
        await cursor.forEach(doc => {
            words[doc.english] = doc.tulu;
        });
        
        console.log(`üìñ Loaded ${Object.keys(words).length} words from MongoDB`);
        return words;
    } catch (error) {
        console.error('‚ùå MongoDB load failed:', error.message);
        return {};
    }
}

async function getWordCountFromMongoDB() {
    if (!mongoAvailable || !db) {
        return Object.keys(learnedWords).length;
    }

    try {
        const count = await db.collection('learned_words').countDocuments();
        return count;
    } catch (error) {
        console.error('‚ùå MongoDB count failed:', error.message);
        return Object.keys(learnedWords).length;
    }
}

async function getRecentWordsFromMongoDB(limit = 5) {
    if (!mongoAvailable || !db) {
        const recent = Object.entries(learnedWords)
            .slice(-limit)
            .map(([english, tulu]) => ({ english, tulu }));
        return recent;
    }

    try {
        const cursor = db.collection('learned_words')
            .find({})
            .sort({ updatedAt: -1 })
            .limit(limit);
        
        const recentWords = [];
        await cursor.forEach(doc => {
            recentWords.push({ english: doc.english, tulu: doc.tulu });
        });
        
        return recentWords;
    } catch (error) {
        console.error('‚ùå MongoDB recent words failed:', error.message);
        return [];
    }
}

// Health check server
const app = express();

app.get('/', async (req, res) => {
    const isKeepAliveActive = keepAliveInterval !== null;
    const timeSinceActivity = lastActivityTime ? Date.now() - lastActivityTime : null;
    let dbWordCount = 0;
    let recentWords = [];
    
    try {
        dbWordCount = await getWordCountFromMongoDB();
        recentWords = await getRecentWordsFromMongoDB(3);
    } catch (error) {
        // Handle error gracefully
    }
    
    const stats = {
        status: 'running',
        bot: 'Complete Cloud Tulu Learning Translator',
        version: '3.0.0',
        uptime: Math.floor(process.uptime() / 60) + ' minutes',
        learned_words: dbWordCount,
        total_words: Object.keys(tuluDictionary).length + dbWordCount,
        recent_words: recentWords,
        keep_alive_active: isKeepAliveActive,
        minutes_since_activity: timeSinceActivity ? Math.floor(timeSinceActivity / (60 * 1000)) : null,
        database: {
            type: mongoAvailable ? 'MongoDB Atlas' : 'Memory Storage',
            region: mongoAvailable ? 'Mumbai (ap-south-1)' : 'Local',
            status: mongoAvailable ? 'Connected' : 'Fallback Mode',
            persistent: mongoAvailable
        },
        features: [
            'Smart Keep-Alive System', 
            'Community Learning Mode',
            'Word Correction System',
            'Complete Number System (0-1000+)',
            'Secure Token Management',
            'Database Fallback System'
        ],
        timestamp: new Date().toISOString()
    };
    res.json(stats);
});

app.get('/health', (req, res) => {
    res.json({ 
        status: 'healthy', 
        keep_alive: keepAliveInterval !== null,
        database: mongoAvailable ? 'MongoDB Atlas Connected' : 'Memory Storage Active',
        timestamp: new Date().toISOString() 
    });
});

// In-memory cache and user states
let learnedWords = {};
const userStates = {};

// Complete comprehensive Tulu dictionary
const tuluDictionary = {
    // Basic Greetings
    'hello': 'namaskara', 'hi': 'namaskara', 'hey': 'namaskara',
    'good morning': 'udige namaskara', 'good evening': 'sanje namaskara',
    'good night': 'ratre namaskara', 'goodbye': 'barpe', 'bye': 'barpe',
    
    // Basic Responses
    'yes': 'aye', 'no': 'illa', 'ok': 'sari', 'okay': 'sari',
    'thank you': 'dhanyavada', 'thanks': 'dhanyavada',
    'welcome': 'swagata', 'sorry': 'kshame', 'please': 'dayavu',
    
    // Numbers (0-20)
    'zero': 'pundu', 'one': 'onji', 'two': 'raddu', 'three': 'muji', 'four': 'nalku',
    'five': 'aidu', 'six': 'aaru', 'seven': 'elu', 'eight': 'enmu', 'nine': 'ombodu', 'ten': 'pattu',
    'eleven': 'pannondu', 'twelve': 'panniraddu', 'thirteen': 'paddmuji', 'fourteen': 'paddnalku', 'fifteen': 'paddaidu',
    'sixteen': 'paddarru', 'seventeen': 'paddelu', 'eighteen': 'paddenmu', 'nineteen': 'paddombodu', 'twenty': 'ippattu',
    
    // Written Numbers (0-100)
    '0': 'pundu', '1': 'onji', '2': 'raddu', '3': 'muji', '4': 'nalku',
    '5': 'aidu', '6': 'aaru', '7': 'elu', '8': 'enmu', '9': 'ombodu', '10': 'pattu',
    '11': 'pannondu', '12': 'panniraddu', '13': 'paddmuji', '14': 'paddnalku', '15': 'paddaidu',
    '16': 'paddarru', '17': 'paddelu', '18': 'paddenmu', '19': 'paddombodu', '20': 'ippattu',
    '21': 'ippatonji', '22': 'ippatraddu', '25': 'ippataidu', '30': 'muppattu',
    
    // Larger Numbers
    'thirty': 'muppattu', 'forty': 'nalpattu', 'fifty': 'aivattu',
    'sixty': 'aruvattu', 'seventy': 'eppattu', 'eighty': 'enpattu', 'ninety': 'tombattu',
    'hundred': 'nuru', 'thousand': 'saayira', 'lakh': 'laksha',
    '30': 'muppattu', '40': 'nalpattu', '50': 'aivattu', '60': 'aruvattu',
    '70': 'eppattu', '80': 'enpattu', '90': 'tombattu', '100': 'nuru', '1000': 'saayira',
    
    // Basic Words & Actions
    'water': 'jalu', 'house': 'mane', 'home': 'mane', 'come': 'bale', 'go': 'pole',
    'good': 'chennu', 'bad': 'kettadu', 'big': 'dodd', 'small': 'kuchi',
    'hot': 'bekku', 'cold': 'thandu', 'food': 'oota', 'eat': 'tinu', 'drink': 'kuDi',
    'sit': 'kur', 'stand': 'nille', 'sleep': 'malpe', 'wake up': 'yetar',
    'walk': 'naDe', 'run': 'oDu', 'stop': 'nille', 'wait': 'tingla',
    
    // Family Relations
    'mother': 'amma', 'father': 'appa', 'brother': 'anna', 'sister': 'akka',
    'grandfather': 'ajja', 'grandmother': 'ajji', 'uncle': 'mama', 'aunt': 'mami',
    'son': 'maga', 'daughter': 'magal', 'husband': 'ganda', 'wife': 'hendati',
    
    // Common Questions & Phrases
    'how are you': 'yenkulu ullar', 'what is your name': 'ninna hesaru yenu',
    'where are you': 'yer yele ullar', 'what are you doing': 'yenu maduttullar',
    'how old are you': 'ninna vayasu yethra', 'where do you live': 'yer vasisu ullar',
    'did you eat': 'oota aayitha', 'what time is it': 'yencha velu aayithu',
    
    // Colors
    'red': 'kempu', 'green': 'pacche', 'blue': 'neeli', 'yellow': 'arishina',
    'white': 'bolpu', 'black': 'karpu', 'brown': 'kahve', 'orange': 'kittale',
    
    // Time & Days
    'today': 'inji', 'yesterday': 'ninale', 'tomorrow': 'naalke',
    'morning': 'udike', 'afternoon': 'madhyanna', 'evening': 'sanje', 'night': 'ratre',
    'time': 'velu', 'now': 'ipuni', 'later': 'aga', 'early': 'bega', 'late': 'kale',
    
    // Places & Directions
    'school': 'shale', 'office': 'karyalaya', 'hospital': 'aspatre',
    'temple': 'deve', 'market': 'pete', 'shop': 'angadi', 'road': 'dhari',
    'village': 'grama', 'city': 'nagara', 'left': 'yeda', 'right': 'bala',
    
    // Weather & Nature
    'rain': 'male', 'sun': 'surya', 'moon': 'chandra', 'star': 'nakshatra',
    'wind': 'gali', 'tree': 'mara', 'flower': 'huvu', 'river': 'aare',
    
    // Body Parts
    'head': 'tale', 'eye': 'kannu', 'nose': 'mookka', 'mouth': 'bayi',
    'hand': 'kai', 'leg': 'kaal', 'hair': 'kess', 'tooth': 'hallu',
    
    // Number-related & Ordinals
    'first': 'modali', 'second': 'randane', 'third': 'munjane', 'last': 'kainche',
    'how many': 'yethra', 'how much': 'yethra', 'count': 'lekka', 'number': 'sankhye',
    'more': 'jai', 'less': 'kam', 'enough': 'saaku', 'little': 'kochi',
    
    // Emotions & States
    'happy': 'santoshi', 'sad': 'dukhi', 'angry': 'kopa', 'tired': 'bejaar',
    'hungry': 'hasive', 'thirsty': 'daaha', 'sick': 'rogi', 'healthy': 'arogya',
    
    // Common Verbs
    'give': 'korle', 'take': 'teele', 'see': 'kan', 'listen': 'kel',
    'speak': 'mal', 'read': 'odu', 'write': 'baraye', 'buy': 'gont',
    'sell': 'achar', 'work': 'kelsa', 'study': 'odu', 'play': 'aaDu'
};

function getCombinedDictionary() {
    return { ...tuluDictionary, ...learnedWords };
}

async function translateToTulu(text, userId) {
    const lowerText = text.toLowerCase().trim();
    const fullDictionary = getCombinedDictionary();
    
    if (fullDictionary[lowerText]) {
        const translation = fullDictionary[lowerText];
        const source = learnedWords[lowerText] ? 'Community taught' : 'Base dictionary';
        console.log(`‚úÖ Found "${translation}" (${source})`);
        return { translation, found: true, source };
    }
    
    console.log(`‚ùì Unknown word: "${text}"`);
    userStates[userId] = {
        mode: 'learning',
        englishWord: lowerText,
        originalText: text,
        timestamp: Date.now()
    };
    
    return { translation: null, found: false, source: 'unknown' };
}

async function learnNewWord(englishWord, tuluTranslation, userId) {
    const lowerEnglish = englishWord.toLowerCase().trim();
    const tuluWord = tuluTranslation.trim();
    
    // Save to MongoDB if available, otherwise memory
    const saved = await saveWordToMongoDB(lowerEnglish, tuluWord);
    
    if (saved) {
        // Always update in-memory cache
        learnedWords[lowerEnglish] = tuluWord;
        delete userStates[userId];
        
        console.log(`üìö Learned: "${lowerEnglish}" = "${tuluWord}" (${mongoAvailable ? 'MongoDB' : 'Memory'})`);
        return true;
    } else {
        console.log(`‚ùå Failed to save: "${lowerEnglish}" = "${tuluWord}"`);
        return false;
    }
}

function clearUserState(userId) {
    if (userStates[userId]) {
        delete userStates[userId];
        return true;
    }
    return false;
}

// Bot commands
bot.onText(/\/start/, async (msg) => {
    const dbWordCount = await getWordCountFromMongoDB();
    const totalWords = Object.keys(tuluDictionary).length + dbWordCount;
    
    extendKeepAlive();
    clearUserState(msg.from.id);
    
    const storageType = mongoAvailable ? 'MongoDB Atlas (Mumbai)' : 'Memory Storage';
    const persistence = mongoAvailable ? 'Permanently preserved' : 'Session-based (resets on restart)';
    
    const welcomeMessage = `üåü *Complete Cloud Tulu Bot!*

${mongoAvailable ? 'üóÑÔ∏è' : 'üíæ'} **Storage:** ${storageType}
üß† **Community Learning System**

üìä **Current Stats:**
‚Ä¢ Base dictionary: ${Object.keys(tuluDictionary).length} words
‚Ä¢ Community learned: ${dbWordCount} words
‚Ä¢ **Total vocabulary: ${totalWords} words**

üíæ **Data Storage:**
${mongoAvailable ? '‚úÖ Words preserved forever (no expiration!)' : '‚ö†Ô∏è Words stored in memory (reset on restart)'}
${mongoAvailable ? '‚úÖ Mumbai data center (fast for India)' : '‚úÖ Instant response (no database delays)'}
‚úÖ ${persistence}

üèì **Smart Keep-Alive System:**
‚úÖ Stays awake during active conversations
‚úÖ Smart resource management
‚úÖ Auto-extends with user activity

üí° **All Commands:**
‚Ä¢ /stats - Complete bot statistics
‚Ä¢ /learned - Community taught words
‚Ä¢ /correct <word> - Fix any translation
‚Ä¢ /numbers - Complete Tulu number system
‚Ä¢ /help - Show this help again
‚Ä¢ /skip - Skip current teaching

üéØ **Try These:**
‚Ä¢ "hello" ‚Üí namaskara
‚Ä¢ "5" or "five" ‚Üí aidu  
‚Ä¢ "did you eat" ‚Üí (teach me authentic Tulu!)
‚Ä¢ "how are you" ‚Üí yenkulu ullar

üöÄ **${mongoAvailable ? 'MongoDB-powered' : 'Memory-based'} community learning!**`;

    bot.sendMessage(msg.chat.id, welcomeMessage, {parse_mode: 'Markdown'});
});

// Help command
bot.onText(/\/help/, async (msg) => {
    bot.onText(/\/start/, msg);
});

// Enhanced stats with storage info
bot.onText(/\/stats/, async (msg) => {
    extendKeepAlive();
    
    const dbWordCount = await getWordCountFromMongoDB();
    const uptime = Math.floor(process.uptime() / 60);
    const hours = Math.floor(uptime / 60);
    const minutes = uptime % 60;
    const isKeepAliveActive = keepAliveInterval !== null;
    const recentWords = await getRecentWordsFromMongoDB(3);
    
    const recentList = recentWords.length > 0 
        ? recentWords.map(w => `‚Ä¢ "${w.english}" ‚Üí "${w.tulu}"`).join('\n')
        : 'None yet - be the first to contribute!';
    
    const statsMessage = `üìä **Complete Cloud Bot Statistics**

${mongoAvailable ? 'üóÑÔ∏è' : 'üíæ'} **Storage:** ${mongoAvailable ? 'MongoDB Atlas (Mumbai)' : 'Memory Storage'}
üõ°Ô∏è **Security:** Secure environment variable management
‚òÅÔ∏è **Hosting:** Render.com with Smart Keep-Alive
‚è±Ô∏è **Uptime:** ${hours}h ${minutes}m
üèì **Keep-Alive:** ${isKeepAliveActive ? 'Active (30min session)' : 'Sleeping - will wake on message'}

üìö **Comprehensive Vocabulary:**
‚Ä¢ **Base dictionary:** ${Object.keys(tuluDictionary).length} words
  *(Numbers, family, colors, actions, emotions, etc.)*
‚Ä¢ **Community learned:** ${dbWordCount} words
‚Ä¢ **Total vocabulary: ${Object.keys(tuluDictionary).length + dbWordCount} words**

üìà **Recent Community Additions:**
${recentList}

üíæ **Storage Details:**
${mongoAvailable ? '‚úÖ MongoDB Atlas (Mumbai region)' : '‚ö†Ô∏è Memory storage (temporary)'}
${mongoAvailable ? '‚úÖ 512MB free storage capacity' : '‚úÖ Instant access (no network delays)'}
${mongoAvailable ? '‚úÖ Zero expiration - truly permanent' : '‚ö†Ô∏è Resets on bot restart'}
${mongoAvailable ? '‚úÖ Real-time sync across all users' : '‚úÖ Session-based learning'}

üéØ **Smart Features Active:**
‚úÖ Context-aware learning mode
‚úÖ Word correction system
‚úÖ Auto-timeout prevention
‚úÖ Conversation flow control
‚úÖ Number system (0-1000+)
‚úÖ Database fallback protection

üèì **Keep-alive extended for 30 more minutes!**`;

    bot.sendMessage(msg.chat.id, statsMessage, {parse_mode: 'Markdown'});
});

// Enhanced learned words
bot.onText(/\/learned/, async (msg) => {
    extendKeepAlive();
    
    const dbWordCount = await getWordCountFromMongoDB();
    
    if (dbWordCount === 0) {
        const storageInfo = mongoAvailable 
            ? 'MongoDB Atlas database' 
            : 'memory storage (temporary)';
            
        bot.sendMessage(msg.chat.id, `üìù **No Words Learned Yet**
        
üéØ **Start building the community dictionary:**
‚Ä¢ Ask me any English word, phrase, or number
‚Ä¢ If I don't know it, I'll ask you to teach me
‚Ä¢ Your contribution gets saved in ${storageInfo}

üíæ **Current Storage:**
${mongoAvailable ? '‚úÖ **MongoDB Atlas** - permanent preservation' : '‚ö†Ô∏è **Memory Storage** - words reset on restart'}
${mongoAvailable ? '‚úÖ **Mumbai hosting** - fast for Indian users' : '‚úÖ **Instant response** - no database delays'}

üí° **Try these to get started:**
‚Ä¢ "did you eat" ‚Üí teach me authentic Tulu
‚Ä¢ "how was your day" ‚Üí add your regional variation
‚Ä¢ "good afternoon" ‚Üí help complete the greetings

üèì Keep-alive extended for 30 minutes`, {parse_mode: 'Markdown'});
        return;
    }
    
    const currentWords = mongoAvailable ? await loadLearnedWordsFromMongoDB() : learnedWords;
    const recentWords = await getRecentWordsFromMongoDB(10);
    
    const recentList = recentWords
        .map(w => `‚Ä¢ "${w.english}" ‚Üí "${w.tulu}"`)
        .join('\n');
    
    const message = `üìö **Community Dictionary**

üíæ **Total Words:** ${dbWordCount}
${mongoAvailable ? 'üóÑÔ∏è **Database:** MongoDB Atlas (Mumbai)' : 'üí≠ **Storage:** Memory (temporary)'}
${mongoAvailable ? '‚úÖ **Status:** Permanently preserved' : '‚ö†Ô∏è **Status:** Session-based'}

**Recent contributions:**
${recentList}

${dbWordCount > 10 ? `\n*üìä ...and ${dbWordCount - 10} more words stored*\n` : ''}

üîß **Available Operations:**
‚Ä¢ **/correct <word>** - Fix any translation
‚Ä¢ **Ask me any word** - Query full vocabulary
‚Ä¢ **Teach new words** - Contribute to community

üí° **Storage Features:**
${mongoAvailable ? '‚úÖ **Instant sync** - Available to all users immediately' : '‚úÖ **Fast access** - No network delays'}
${mongoAvailable ? '‚úÖ **Backup redundancy** - Multiple copies across regions' : '‚ö†Ô∏è **Session-based** - Resets when bot restarts'}
${mongoAvailable ? '‚úÖ **Search optimization** - Fast lookups with indexing' : '‚úÖ **Memory-optimized** - Lightning fast responses'}

üåç **Building authentic Tulu preservation together!**
üèì Keep-alive extended for 30 minutes`;
    
    bot.sendMessage(msg.chat.id, message, {parse_mode: 'Markdown'});
});

// Enhanced correct command
bot.onText(/\/correct (.+)/, async (msg, match) => {
    extendKeepAlive();
    
    const userId = msg.from.id;
    const wordToCorrect = match[1].toLowerCase().trim();
    
    const currentWords = mongoAvailable ? await loadLearnedWordsFromMongoDB() : learnedWords;
    const fullDictionary = { ...tuluDictionary, ...currentWords };
    
    if (fullDictionary[wordToCorrect]) {
        const currentTranslation = fullDictionary[wordToCorrect];
        const source = currentWords[wordToCorrect] ? 'community-taught' : 'base dictionary';
        
        if (source === 'base dictionary') {
            await bot.sendMessage(msg.chat.id, `‚ùå **Cannot Correct Base Dictionary Word**
            
üìù **Word:** "${wordToCorrect}"
üèõÔ∏è **Current Translation:** "${currentTranslation}"
üìñ **Source:** Base dictionary (built-in)

‚ö†Ô∏è This word is from the built-in Tulu dictionary. You can teach me a regional variation by asking me to translate "${wordToCorrect}" and I'll ask you for the authentic local version.

üí° **Alternative:** Ask me "${wordToCorrect}" to see current translation, then teach me your preferred version.

üèì Keep-alive extended for 30 minutes`, {parse_mode: 'Markdown'});
            return;
        }
        
        userStates[userId] = {
            mode: 'correcting',
            englishWord: wordToCorrect,
            originalText: wordToCorrect,
            oldTranslation: currentTranslation,
            timestamp: Date.now()
        };
        
        const storageInfo = mongoAvailable ? 'MongoDB Atlas (Mumbai)' : 'Memory Storage';
        
        await bot.sendMessage(msg.chat.id, `üîß **Word Correction Mode**

üìù **English:** "${wordToCorrect}"
üèõÔ∏è **Current Tulu:** "${currentTranslation}"
üíæ **Source:** Community ${storageInfo}

‚úèÔ∏è **Send the correct Tulu translation now:**

üí° **Or use /skip to cancel correction**
üåç **Your correction will be ${mongoAvailable ? 'saved permanently and available to all users' : 'stored in memory for this session'}**
üèì Keep-alive extended for 30 minutes`, {parse_mode: 'Markdown'});
    } else {
        await bot.sendMessage(msg.chat.id, `‚ùå **Word Not Found**
        
üìù **"${wordToCorrect}"** is not in our vocabulary yet.

üéØ **Options:**
1Ô∏è‚É£ **Teach it:** Ask me to translate "${wordToCorrect}" and I'll learn it from you
2Ô∏è‚É£ **Check spelling:** Make sure the English word is spelled correctly
3Ô∏è‚É£ **View all words:** Use /learned to see current vocabulary

üíæ **Once taught, it will be stored in ${mongoAvailable ? 'MongoDB Atlas permanently' : 'memory for this session'}**
üèì Keep-alive extended for 30 minutes`, {parse_mode: 'Markdown'});
    }
});

// Numbers reference
bot.onText(/\/numbers/, (msg) => {
    extendKeepAlive();
    
    const numbersMessage = `üî¢ **Complete Tulu Numbers Reference**

**Basic Numbers (0-10):**
‚Ä¢ 0 ‚Üí pundu ‚Ä¢ 1 ‚Üí onji ‚Ä¢ 2 ‚Üí raddu ‚Ä¢ 3 ‚Üí muji ‚Ä¢ 4 ‚Üí nalku ‚Ä¢ 5 ‚Üí aidu
‚Ä¢ 6 ‚Üí aaru ‚Ä¢ 7 ‚Üí elu ‚Ä¢ 8 ‚Üí enmu ‚Ä¢ 9 ‚Üí ombodu ‚Ä¢ 10 ‚Üí pattu

**Teens (11-20):**
‚Ä¢ 11 ‚Üí pannondu ‚Ä¢ 12 ‚Üí panniraddu ‚Ä¢ 13 ‚Üí paddmuji ‚Ä¢ 14 ‚Üí paddnalku ‚Ä¢ 15 ‚Üí paddaidu
‚Ä¢ 16 ‚Üí paddarru ‚Ä¢ 17 ‚Üí paddelu ‚Ä¢ 18 ‚Üí paddenmu ‚Ä¢ 19 ‚Üí paddombodu ‚Ä¢ 20 ‚Üí ippattu

**Larger Numbers:**
‚Ä¢ 30 ‚Üí muppattu ‚Ä¢ 40 ‚Üí nalpattu ‚Ä¢ 50 ‚Üí aivattu ‚Ä¢ 60 ‚Üí aruvattu ‚Ä¢ 70 ‚Üí eppattu
‚Ä¢ 80 ‚Üí enpattu ‚Ä¢ 90 ‚Üí tombattu ‚Ä¢ 100 ‚Üí nuru ‚Ä¢ 1000 ‚Üí saayira ‚Ä¢ 1 lakh ‚Üí laksha

**Number Words:**
‚Ä¢ "how many" ‚Üí yethra ‚Ä¢ "first" ‚Üí modali ‚Ä¢ "second" ‚Üí randane ‚Ä¢ "third" ‚Üí munjane
‚Ä¢ "more" ‚Üí jai ‚Ä¢ "less" ‚Üí kam ‚Ä¢ "enough" ‚Üí saaku

üí° **Usage Examples:**
‚Ä¢ Type "5" or "five" ‚Üí aidu
‚Ä¢ Type "25" or "twenty five" ‚Üí (teach me!)
‚Ä¢ Type "how many" ‚Üí yethra

üìö **All numbers stored in base dictionary - no need to teach basic numbers!**
üèì Keep-alive extended for 30 minutes`;

    bot.sendMessage(msg.chat.id, numbersMessage, {parse_mode: 'Markdown'});
});

// Enhanced main message handler
bot.on('message', async (msg) => {
    if (msg.text && !msg.text.startsWith('/')) {
        const userText = msg.text.trim();
        const userId = msg.from.id;
        const userName = msg.from.first_name || 'User';
        
        extendKeepAlive();
        console.log(`üì© ${userName}: "${userText}" (keep-alive extended)`);
        
        // Reload learned words if MongoDB is available
        if (mongoAvailable) {
            learnedWords = await loadLearnedWordsFromMongoDB();
        }
        
        // Check if user is in learning or correction mode
        if (userStates[userId]) {
            const userState = userStates[userId];
            
            if (userState.mode === 'learning') {
                const success = await learnNewWord(userState.englishWord, userText, userId);
                
                if (success) {
                    const storageType = mongoAvailable ? 'MongoDB Atlas (Mumbai)' : 'memory storage';
                    const persistence = mongoAvailable ? 'preserved forever' : 'available for this session';
                    
                    const successMessage = `‚úÖ **Learned & Saved!**

üìù **English:** ${userState.originalText}
üèõÔ∏è **Authentic Tulu:** ${userText}

üíæ **Stored in ${storageType}** - ${persistence}
${mongoAvailable ? 'üåç Available to all users immediately' : '‚ö° Instant in-memory access'}
üèì **Bot staying awake for 30 more minutes**

üí° **Test it:** Ask me "${userState.originalText}" again!
üôè **Thank you for helping preserve authentic Tulu!**`;

                    await bot.sendMessage(msg.chat.id, successMessage, {parse_mode: 'Markdown'});
                } else {
                    await bot.sendMessage(msg.chat.id, `‚ùå **Save Error**

üö® Could not save "${userState.originalText}" properly.

üí° **Please try again:** Ask me "${userState.originalText}" again and I'll learn it from you.

üèì Keep-alive extended for 30 minutes`);
                    
                    delete userStates[userId];
                }
                return;
                
            } else if (userState.mode === 'correcting') {
                const oldTranslation = userState.oldTranslation;
                const success = await learnNewWord(userState.englishWord, userText, userId);
                
                if (success) {
                    const storageType = mongoAvailable ? 'MongoDB Atlas' : 'memory storage';
                    
                    const correctionMessage = `‚úÖ **Word Corrected!**

üìù **English:** ${userState.originalText}
‚ùå **Old Tulu:** ${oldTranslation}  
‚úÖ **New Tulu:** ${userText}

üíæ **Updated in ${storageType}!**
${mongoAvailable ? 'üåç Correction available to all users immediately' : '‚ö° Updated in current session'}
üèì **Bot staying awake for 30 more minutes**

üí° **Verify:** Ask me "${userState.originalText}" to confirm the correction
üéØ **Community-driven accuracy** - thank you for the improvement!`;

                    await bot.sendMessage(msg.chat.id, correctionMessage, {parse_mode: 'Markdown'});
                } else {
                    await bot.sendMessage(msg.chat.id, `‚ùå **Update Error**

üö® Could not update "${userState.originalText}".

üí° **Please try the correction again:** Use /correct ${userState.originalText}

üèì Keep-alive extended for 30 minutes`);
                    
                    delete userStates[userId];
                }
                return;
            }
        }
        
        // Normal translation request
        const englishPattern = /^[a-zA-Z0-9\s.,!?'"-]+$/;
        
        if (englishPattern.test(userText)) {
            bot.sendChatAction(msg.chat.id, 'typing');
            
            const result = await translateToTulu(userText, userId);
            
            if (result.found) {
                const confidence = result.source === 'Community taught' ? 'üéØ' : 
                                result.source === 'Base dictionary' ? '‚úÖ' : '‚ö†Ô∏è';
                
                const storageInfo = mongoAvailable ? 'MongoDB Atlas (Mumbai)' : 'Memory Storage';
                
                const response = `üîÑ **Translation Result**

üìù **English:** ${userText}
üèõÔ∏è **Tulu:** ${result.translation}

${confidence} **Source:** ${result.source}
üíæ **Storage:** ${storageInfo}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üí° **Want to correct this?** /correct ${userText.toLowerCase()}
üìä **Bot statistics:** /stats
üî¢ **Number reference:** /numbers
üèì **Bot staying awake** for 30 more minutes`;

                await bot.sendMessage(msg.chat.id, response, {parse_mode: 'Markdown'});
                
            } else {
                const vocabCount = Object.keys(tuluDictionary).length + Object.keys(learnedWords).length;
                const storageType = mongoAvailable ? 'MongoDB Atlas' : 'memory storage';
                
                const learnMessage = `‚ùì **"${userText}" not found**

üóÑÔ∏è **Searched:** ${vocabCount} words in ${storageType}

üéØ **Help build the community dictionary:**

1Ô∏è‚É£ **Teach me:** Reply with the authentic Tulu translation
2Ô∏è‚É£ **Skip this:** Use /skip to try a different word
3Ô∏è‚É£ **Get help:** Use /numbers for number references

üíæ **Your contribution will be:**
${mongoAvailable ? '‚úÖ **Preserved permanently** in MongoDB Atlas' : '‚ö†Ô∏è **Stored in memory** for this session'}
${mongoAvailable ? '‚úÖ **Available instantly** to all users worldwide' : '‚úÖ **Instantly accessible** with no delays'}
‚úÖ **Helps preserve** authentic Tulu language
‚úÖ **Builds community** knowledge base

üèõÔ∏è **Share your authentic Tulu knowledge!**
‚è∞ **This teaching request expires in 10 minutes**
üèì **Bot staying awake** for 30 minutes`;

                await bot.sendMessage(msg.chat.id, learnMessage, {parse_mode: 'Markdown'});
                
                // Auto-expire learning state after 10 minutes
                setTimeout(() => {
                    if (userStates[userId] && userStates[userId].englishWord === userText.toLowerCase()) {
                        delete userStates[userId];
                        bot.sendMessage(msg.chat.id, `‚è∞ **Teaching session expired for "${userText}"**
                        
üîÑ **You can ask me any new word or number now!**
üí° **Try:** /numbers for complete number reference
üéØ **Or ask:** Any other English word to translate

üèì Bot ready for new queries!`).catch(() => {});
                    }
                }, 10 * 60 * 1000); // 10 minutes
            }
        } else {
            const vocabCount = Object.keys(getCombinedDictionary()).length;
            
            await bot.sendMessage(msg.chat.id, `‚ùå **Please send English text or numbers only**

‚úÖ **Supported formats:**
‚Ä¢ **English words:** hello, good morning, thank you
‚Ä¢ **Numbers:** 1, 2, 5, 10, 50, 100 (or spelled out)
‚Ä¢ **Simple phrases:** how are you, what is your name
‚Ä¢ **Questions:** did you eat, where are you

üìä **Current capability:** ${vocabCount} total words
üî¢ **Numbers:** Complete system 0-1000+
üèõÔ∏è **Focus:** English to authentic Tulu translation

üí° **Try /numbers** for complete number reference
üèì Keep-alive extended for 30 minutes`, {parse_mode: 'Markdown'});
        }
    }
});

// Skip/cancel commands
bot.onText(/\/skip|\/cancel/, (msg) => {
    extendKeepAlive();
    
    const userId = msg.from.id;
    const cleared = clearUserState(userId);
    
    if (cleared) {
        const storageType = mongoAvailable ? 'MongoDB database' : 'memory storage';
        
        bot.sendMessage(msg.chat.id, `‚úÖ **Learning Session Cancelled**
        
üîÑ **Ready for new queries!**
‚Ä¢ Ask me any English word or number
‚Ä¢ Try /numbers for complete reference
‚Ä¢ Use /stats to see current vocabulary

üíæ **${storageType}** ready for new contributions
üèì Keep-alive extended for 30 more minutes`, {parse_mode: 'Markdown'});
    } else {
        const vocabCount = Object.keys(getCombinedDictionary()).length;
        
        bot.sendMessage(msg.chat.id, `üí≠ **No active learning session**

üéØ **Ready to help!** Ask me:
‚Ä¢ Any English word for Tulu translation
‚Ä¢ Numbers (try "fifty" or "100")
‚Ä¢ Common phrases ("how are you")

üìä **Current vocabulary:** ${vocabCount} words
üî¢ **Complete number system** available
üèì Keep-alive extended for 30 minutes`);
    }
});

// Error handling
bot.on('error', (error) => {
    console.error('üö® Bot error:', error);
});

bot.on('polling_error', (error) => {
    console.error('üö® Polling error:', error);
});

// Graceful shutdown
process.on('SIGTERM', async () => {
    console.log('üì¥ Shutting down gracefully...');
    if (client && mongoAvailable) {
        await client.close();
        console.log('üóÑÔ∏è MongoDB connection closed');
    }
    bot.stopPolling();
    process.exit(0);
});

process.on('SIGINT', async () => {
    console.log('üì¥ Shutting down gracefully...');
    if (client && mongoAvailable) {
        await client.close();
        console.log('üóÑÔ∏è MongoDB connection closed');
    }
    bot.stopPolling();
    process.exit(0);
});

// Start health check server
app.listen(PORT, () => {
    console.log(`üåê Health check server running on port ${PORT}`);
    console.log(`üìä Bot statistics available at: http://localhost:${PORT}`);
});

// Enhanced startup with fallback handling
async function startBot() {
    try {
        console.log('üîß Initializing database connection...');
        mongoAvailable = await initializeMongoDB();
        
        if (!mongoAvailable) {
            console.log('‚ö†Ô∏è Running without MongoDB - using memory storage');
            console.log('‚úÖ Bot will still work with base dictionary and session-based learning!');
            console.log('üí° MongoDB can be added later without affecting functionality');
        } else {
            console.log('üìö Loading learned words from database...');
            learnedWords = await loadLearnedWordsFromMongoDB();
        }
        
        console.log('ü§ñ Starting Telegram bot...');
        const botInfo = await bot.getMe();
        const dbWordCount = await getWordCountFromMongoDB();
        
        console.log('‚úÖ ================================================');
        console.log('‚úÖ COMPLETE CLOUD TULU BOT IS LIVE!');
        console.log('‚úÖ ================================================\n');
        
        console.log(`ü§ñ Bot: @${botInfo.username}`);
        console.log(`üóÑÔ∏è Storage: ${mongoAvailable ? 'MongoDB Atlas (Mumbai)' : 'Memory Storage'}`);
        console.log(`üõ°Ô∏è Security: Secure environment variable management`);
        console.log(`‚òÅÔ∏è Hosting: Render.com with Smart Keep-Alive`);
        console.log(`üèì Keep-Alive: Ready (30min sessions)`);
        console.log(`üìö Base dictionary: ${Object.keys(tuluDictionary).length} words`);
        console.log(`üíæ Learned words: ${dbWordCount} words`);
        console.log(`üéØ Total vocabulary: ${Object.keys(tuluDictionary).length + dbWordCount} words`);
        console.log(`üåç ${mongoAvailable ? 'Preserving authentic Tulu permanently!' : 'Ready for session-based learning!'}`);
        console.log(`${mongoAvailable ? 'üáÆüá≥ Optimized for Indian users with Mumbai hosting' : '‚ö° Lightning-fast memory-based responses'}\n`);
        
        console.log('üöÄ Bot fully operational and ready for users!');
        
    } catch (error) {
        console.error('‚ùå Bot startup failed:', error);
        process.exit(1);
    }
}

// Start the complete enhanced bot
startBot();
